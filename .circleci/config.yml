version: 2

jobs:
  build:
    # We use machine executor as docker executor won't allow mounting of folders.
    machine:
      image: ubuntu-1604:201903-01 # Note: There is an overhead for provisioning a machine executor as a result of spinning
      # up a private Docker server. Use of the machine key may require additional fees in a future pricing update.
      docker_layer_caching: true
    resource_class: large

    working_directory: ~/hypertrace
    steps:
      - checkout
      #      - setup_remote_docker:
      #          version: "19.03.12"
      #      - run: # official docs won't work, see https://github.com/circleci/circleci-docs/issues/1323#issuecomment-323620271
      #          name: Install Docker Compose
      #          command: |
      #            set -x
      #            curl -L https://github.com/docker/compose/releases/download/1.24.1/docker-compose-`uname -s`-`uname -m` > ~/docker-compose
      #            chmod +x ~/docker-compose
      #            sudo mv ~/docker-compose /usr/local/bin/docker-compose

      # makes sure pinot is being provissioned on beforehand
      #- run: |
      #    docker-compose -f docker/docker-compose.yml -f docker/docker-compose-zipkin-example.yml up -d pinot || (docker-compose -f docker/docker-compose.yml -f docker/docker-compose-zipkin-example.yml logs; exit 1)
      #    sleep 60
      - run: |
          cd ./docker
          docker-compose -f docker-compose.yml -f docker-compose-zipkin-example.yml up -d || (docker-compose -f docker-compose.yml -f docker-compose-zipkin-example.yml logs; exit 1)
      #- run: docker network ls
      # When using docker/docker-compose inside CI we can't ping them directly, hence we need
      # to use another container to run the desired scripts
      # https://circleci.com/docs/2.0/building-docker-images/#accessing-services
      - run: |
          sleep 120
          docker ps
          .circleci/tests.sh || { docker ps ; exit 1 }
      #- run: |
      #    docker build -t tests .circleci/
      #    docker run --network docker_default tests hypertrace-federated-service frontend

workflows:
  version: 2
  commit:
    jobs:
      - build
