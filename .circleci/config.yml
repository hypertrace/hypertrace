version: 2

jobs:
  build:
    docker:
      - image: cimg/base:2020.01
    working_directory: ~/hypertrace
    steps:
      - checkout
      - setup_remote_docker
      - run: # official docs won't work, see https://github.com/circleci/circleci-docs/issues/1323#issuecomment-323620271
          name: Install Docker Compose
          command: |
            set -x
            curl -L https://github.com/docker/compose/releases/download/1.24.1/docker-compose-`uname -s`-`uname -m` > ~/docker-compose
            chmod +x ~/docker-compose
            sudo mv ~/docker-compose /usr/local/bin/docker-compose

      - run: docker-compose -f docker/docker-compose.yml -f docker/docker-compose-zipkin-example.yml up -d || docker-compose -f docker/docker-compose.yml -f docker/docker-compose-zipkin-example.yml logs
      - run: wget --retry-connrefused -T 60 -O /dev/null http://127.0.0.1:2020/
      - run: curl -i http://localhost:8081
      - run: cp .circleci/query.gql.template .circleci/query.gql
      - run: sed 's/%startTime%/$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")' .circleci/query.gql
      - run: curl -X POST http://localhost:2020/graphql --data "@.circleci/query.gql" | jq .

workflows:
  version: 2
  commit:
    jobs:
      - build
