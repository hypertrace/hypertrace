version: 2

jobs:
  build:
    # We use machine executor as docker executor won't allow mounting of folders.
    machine:
      image: ubuntu-1604:201903-01 # Note: There is an overhead for provisioning a machine executor as a result of spinning
      # up a private Docker server. Use of the machine key may require additional fees in a future pricing update.
      docker_layer_caching: true
    resource_class: large
    working_directory: ~/hypertrace
    steps:
      - checkout
      - run: |
          cd ./docker
          docker-compose -f docker-compose.yml -f docker-compose-zipkin-example.yml up -d pinot || (docker-compose -f docker-compose.yml -f docker-compose-zipkin-example.yml logs; exit 1)
          sleep 60
      - run: |
          cd ./docker
          docker-compose -f docker-compose.yml -f docker-compose-zipkin-example.yml ps
          docker-compose -f docker-compose.yml -f docker-compose-zipkin-example.yml up -d || (docker-compose -f docker-compose.yml -f docker-compose-zipkin-example.yml logs; exit 1)
      - run: |
          sleep 10
          cd ./docker
          docker-compose -f docker-compose.yml -f docker-compose-zipkin-example.yml ps
          curl -I localhost:2020

workflows:
  version: 2
  commit:
    jobs:
      - build
